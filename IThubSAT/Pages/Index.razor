@page "/"
@using IThubSAT.Components
@using IThubSAT.Data
@using IThubSAT.Data.Models
@using System.Linq
@inject SurveyService SurveyService
@inject NavigationManager Navigation

<TopBar PageName="Главная" Username="User"/>
<div class="main-content">
    <div class="white-background-content">
        <TabsBar Tabs=Tabs OnTabChosen=OnTabChosen />

        <div class="tab-content">
            <div class="surveys-list">
                @if(_filteredSurveys.Count > 0){
                    @foreach(var survey in _filteredSurveys)
                    {
                        <SurveyListItem Survey=@survey />
                    }
                }
                else {
                    <p>Здесь ничего нет...</p>
                }
            </div>
            <button class="primary-button" @onclick=@AddSurvey>
                Создать +
            </button>
        </div>
    </div>
</div>

@*@ref позволяет ссылаться на один и тот же инстанс, а не создавать каждый раз новые модалки??? *@ 
<AddSurveyPopUp @ref="AddSurveyPopUp" CloseEventCallback=AddSurvey_OnDialogClose></AddSurveyPopUp>

@code {
    protected List<Survey> _surveys = new List<Survey>();
    private string text = string.Empty;
    protected List<Survey> _filteredSurveys = new();

    public AddSurveyPopUp AddSurveyPopUp { get; set; } = null!;

    protected override void OnInitialized()
    {
        _surveys = SurveyService.GetSurveys();
        OnTabChosen(Tabs[0]);
        base.OnInitialized();
    }

    List<Tab> Tabs = new() { Tab.Active, Tab.Stopped, Tab.Drafts, Tab.All };
    public void OnTabChosen (Tab chosenTab) {
        _filteredSurveys = chosenTab switch 
        {
            Tab.Active => _surveys.Where(s => s.IsOpen == true).ToList(),
            Tab.Stopped => _surveys.Where(s => (s.IsOpen == false) & (s.EndDate != string.Empty)).ToList(),
            Tab.Drafts => _surveys.Where(s => (s.IsOpen == false) & (s.StartDate != string.Empty)).ToList(),
            Tab.All => _surveys,
            _ => _surveys
        };
    }
    private void AddSurvey()
    {
        AddSurveyPopUp.Show();
    }

    public void AddSurvey_OnDialogClose(int id)
    {
        Console.WriteLine(id);
        // ничё не делает...
        Navigation.NavigateTo($"/surveys/{id}");
        StateHasChanged();
    }
}